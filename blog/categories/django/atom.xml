<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: django | baechtold.me]]></title>
  <link href="http://baechtold.me/blog/categories/django/atom.xml" rel="self"/>
  <link href="http://baechtold.me/"/>
  <updated>2012-02-25T08:48:50+01:00</updated>
  <id>http://baechtold.me/</id>
  <author>
    <name><![CDATA[Martin Bächtold]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Serving Django powered websites with Cherokee and uWSGI on Debian]]></title>
    <link href="http://baechtold.me/blog/2012/02/23/serving-django-powered-website-with-cherokee-uwsgi-debian/"/>
    <updated>2012-02-23T13:42:00+01:00</updated>
    <id>http://baechtold.me/blog/2012/02/23/serving-django-powered-website-with-cherokee-uwsgi-debian</id>
    <content type="html"><![CDATA[<p>There are many ways to serve your Django powered websites i.e. with Apache/mod_wsgi or Nginx/Gunicorn. Another setup includes Cherokee and uWSGI. What follows are the notes I took during the setup of my Cherokee/uWSGI stack.</p>

<!-- more -->


<p>These are the main ingredients for this setup:</p>

<ul>
<li>Debian 6 (Squeeze)</li>
<li><a href="http://www.cherokee-project.com/">Cherokee</a> (1.0.8)</li>
<li><a href="http://projects.unbit.it/uwsgi/">uWSGI</a> (1.0.4)</li>
<li>Some helpful tools for python: <a href="http://www.virtualenv.org/">virtualenv</a>, <a href="http://www.doughellmann.com/projects/virtualenvwrapper/">virtualenvwrapper</a> and <a href="http://www.pip-installer.org/">pip</a></li>
</ul>


<h2>Preliminaries</h2>

<p>I created an unprivileged user called <em>web</em> on my server. All the virtualenvs and Django sites will be stored in this user's home directory.</p>

<h2>Installing Cherokee web server</h2>

<p><img class="right" src="/images/cherokee/v1_0_8/cherokee_test_page.png" width="190" title="Cherokee Test Page" ></p>

<p>Installing the Cherokee web server is easy. Basically you only need one package — the server itself: <code>$ apt-get install cherokee</code></p>

<p>Additionally you may choose to install some of its <a href="http://packages.debian.org/search?keywords=libcherokee-mod&amp;searchon=names&amp;suite=stable&amp;section=all">plugins</a> too.</p>

<p>That's it. Enter the public IP or FQDN of your server in a browser and you should see Cherokee's default page.</p>

<h2>Installing uWSGI</h2>

<p>I had to build <em>uWSGI</em> from source since there is no packaged version of <em>uWSGI</em> for Debian 6 (Squeeze) available. Note that the following commands have to be run as root (or with sudo).</p>

<p>Install some required software packages: <code>$ apt-get install build-essential python-dev libxml2-dev</code></p>

<p>Now fetch and compile <em>uWSGI</em>:</p>

<p><code>
$ cd /tmp
$ wget http://projects.unbit.it/downloads/uwsgi-latest.tar.gz
$ tar xvf uwsgi-latest.tar.gz
$ cd uwsgi-*/
$ make
$ mv uwsgi /usr/local/bin
</code></p>

<p>Change the owner of <em>uWSGI</em> to <em>www-data</em>:</p>

<p><code>
$ chown -R www-data:www-data /usr/local/bin/uwsgi
$ touch /var/log/uwsgi.log
$ chown www-data /var/log/uwsgi.log
</code></p>

<h2>Virtual environments for Python</h2>

<p>Of course we're going to take advantage of <em>virtualenv</em> and <em>pip</em>. Feel free to also install <em>virtualenvwrapper</em> to make switching between virtual environments a lot easier. Note that the following commands have to be run as root (or with sudo).</p>

<p>Install <em>distribute</em>:
<code>$ curl http://python-distribute.org/distribute_setup.py | python</code></p>

<p>Install <em>pip</em> into python's global site-packages:
<code>$ easy_install pip</code></p>

<p>Install <em>virtualenv</em> into python's global site-packages:
<code>$ pip install virtualenv</code></p>

<p>Optional: Install <em>virtualenvwrapper</em> into python's global site-packages:
<code>$ pip install virtualenvwrapper</code></p>

<h2>Where the Django projects live</h2>

<p>All my Django projects are going to be stored in an (unprivileged) user's home directory (the user is called <em>web</em>). So log in as the user <em>web</em> and create the directories <code>~/sites</code>, <code>~/virtualenvs</code> and <code>~/.pip</code>. Note that the following settings and commands have to be done as the (unprivileged) user <em>web</em> and not as <em>root</em>.</p>

<p>If you have installed <em>virtuelnvwrapper</em> you should add the following lines to <code>~/.bashrc</code> and reload it with <code>$ source ~/.bashrc</code>.</p>

<p><code>
export WORKON_HOME=$HOME/virtualenvs
export PROJECT_HOME=$HOME/sites
source /usr/local/bin/virtualenvwrapper.sh
</code></p>

<p>By adding the following lines to <code>~/.pip/pip.conf</code> you'll tell <em>pip</em> to locally cache the downloaded python packages. Using the PyPI mirrors is a good idea too in case the primary PyPI server is unreachable.</p>

<p>```
[global]
timeout = 60</p>

<p>[freeze]
timeout = 10</p>

<p>[install]</p>

<h1>ignore-installed = true</h1>

<h1>no-dependencies = yes</h1>

<p>download-cache=~/.pip/cache/
use-mirrors = true
mirrors =</p>

<pre><code>http://d.pypi.python.org
http://b.pypi.python.org
</code></pre>

<p>```</p>

<p>Create a virtualenv for the Django project you're going to deploy (replace "django.example.com" with a meaningful name of your project): <code>$ mkvirtualenv --no-site-packages django.example.com</code>. Please note that <code>mkvirtualenv</code> is a command from <em>virtualenvwarpper</em>. Use <code>virtualenv</code> if have not installed <em>virtualenvwrapper</em>.</p>

<p>Next you would deploy your project into <code>~/sites/django.example.com</code> and install the required python packages with <em>pip</em>.</p>

<p>If you need to create a database, now is the time to run the management commands like <code>syncdb</code> and <code>migrate</code> (yes, you should use <a href="http://south.aeracode.org/">South</a>). Execute any other task of your deployment process, i.e. the <code>collectstatic</code> management command.</p>

<h2>uWSGI config</h2>

<p>In order to get <em>uWSGI</em> to execute the Django app, two additional files are required: <em>uwsgi.conf</em> and <em>django_wsgi.py</em>.</p>

<p>The former is an xml file where you define one or more paths to be added to the PYTHONPATH environment variable and the mount point for your application. The latter is a python module where you define your WSGI configuration needed by <em>uWSGI</em>.</p>

<p>It's nice to have a <em>touch</em> file configured in <code>&lt;touch-reload&gt;</code> in order to easily restart the application.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>uwsgi.conf  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uwsgi&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pythonpath&gt;</span>/home/web/sites/django.example.com<span class="nt">&lt;/pythonpath&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pythonpath&gt;</span>/home/web/sites/django.example.com/uwsgi<span class="nt">&lt;/pythonpath&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pythonpath&gt;</span>/home/web/virtualenvs/django.example.com/lib/python2.6/site-packages<span class="nt">&lt;/pythonpath&gt;</span>
</span><span class='line'>  <span class="nt">&lt;touch-reload&gt;</span>/home/web/sites/django.example.com/uwsgi/restart.txt<span class="nt">&lt;/touch-reload&gt;</span>
</span><span class='line'>  <span class="nt">&lt;app</span> <span class="na">mountpoint=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>script<span class="ni">&amp;gt;</span>django_wsgi<span class="ni">&amp;lt;</span>/script<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;/app&gt;</span>
</span><span class='line'><span class="nt">&lt;/uwsgi&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>django_wsgi.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">django.core.handlers.wsgi</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;demo_project.settings&#39;</span>
</span><span class='line'><span class="n">application</span> <span class="o">=</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">WSGIHandler</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The directory structure now should look something like this:</p>

<p><code>``
/home/web/sites/django.example.com/
|-- demo_project
|   |-- __init__.py
|   |-- manage.py
|   |-- settings.py
|  </code>-- urls.py
`-- uwsgi</p>

<pre><code>|-- django_wsgi.py
`-- uwsgi.conf
</code></pre>

<p>```</p>

<h2>Inside Cherokee's admin interface</h2>

<p>Now we need to tell Cherokee to handle the incoming requests and delegate them to <em>uWSGI</em>.
Launch Cherokee's admin interface by running <code>$ cherokee-admin</code> as a superuser (or any other user having write access to <code>/etc/cherokee/cherokee.conf</code>). The output should look similar to the following lines:</p>

<p>```
$ cherokee-admin</p>

<p>Login:
  User:              admin
  One-time Password: abcdefghijklmnopqr</p>

<p>Web Interface:
  URL:               http://127.0.0.1:9090/</p>

<p>Cherokee Web Server 1.0.8 (Nov 28 2011): Listening on port 127.0.0.1:9090, TLS
disabled, IPv6 enabled, using epoll, 4096 fds system limit, max. 2041
connections, caching I/O, single thread
```</p>

<p>As you can see, the admin interface is only listening on localhost and port 9090. So you need to open an ssh tunnel on your local machine: <code>ssh -L 9090:localhost:9090 user@your_server</code>. Then open <code>http://localhost:9090</code> in a browser on your local machine. Welcome to Cherokees's admin interface:</p>

<p><img src="/images/cherokee/v1_0_8/admin/cherokee_admin_welcome.png" title="'Cherokee Admin'" ></p>

<h4>Create a new vServer for your Django project</h4>

<ol>
<li>Choose "vServers" from the top menu</li>
<li>Click the button labelled "New" in the upper left corner</li>
<li>Choose "Platforms", then "uWSGI" from the popup</li>
<li>Click "Add" in the popup to launch the wizard</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/cherokee_admin_vserver_new.png" title="'Cherokee Admin'" ></p>

<p>Click "Next" in the wizard.</p>

<p><img src="/images/cherokee/v1_0_8/admin/vservers/cherokee_admin_vserver_uwsgi_wizard.png" title="'Cherokee Admin'" ></p>

<ol>
<li>Enter the path to the <em>uWSGI</em> xml config file, i.e. <code>/home/web/sites/django.example.com/uwsgi/uwsgi.conf</code></li>
<li>Click "Next"</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/cherokee_admin_vserver_uwsgi_wizard_config.png" title="'Cherokee Admin'" ></p>

<ol>
<li>Enter the host name of the website, i.e. "django.example.com" (you can add more host names once the vServer is created)</li>
<li>Enter the path to the project root of your Django project, i.e. <code>/home/web/sites/django.example.com/demo_project</code></li>
<li>Click "Create"</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/cherokee_admin_vserver_uwsgi_wizard_details.png" title="'Cherokee Admin'" ></p>

<p>Now the new <em>vServer</em> is created and listed on the "vServers" page.</p>

<p><img src="/images/cherokee/v1_0_8/admin/vservers/cherokee_admin_vserver_uwsgi_wizard_finished.png" title="'Cherokee Admin'" ></p>

<h4>Adjust the source</h4>

<p>Choose "Sources" from the top menu. You should see a new source added by the wizard.</p>

<p><img src="/images/cherokee/v1_0_8/admin/sources/cherokee_admin_uwsgi_source.png" title="'Cherokee Admin'" ></p>

<ol>
<li>You may want to change the source's <em>Nick</em> to something more related to your Django project, i.e. django.example.com (this is simply the name/label of the source, you can change it as you please)</li>
<li>Adjust the value of the field <em>Interpreter</em>:

<ul>
<li>The <em>interpreter</em> created by the wizard needs to point to the virtualenv, so change the <em>-H</em> flag from <code>/home/web/sites/django.example.com</code> to <code>/home/web/virtualenvs/django.example.com</code></li>
<li>My <em>interpreter</em> value now looks like this: <code>/usr/local/bin/uwsgi -s 127.0.0.1:52499 -t 10 -M -p 1 -C  -x /home/web/sites/django.example.com/uwsgi/uwsgi.conf -H /home/web/virtualenvs/django.example.com</code></li>
</ul>
</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/sources/cherokee_admin_uwsgi_source_changed.png" title="'Cherokee Admin'" ></p>

<h4>Serving static files</h4>

<p>As a last step we need to take care of the static files like <code>MEDIA_ROOT</code> and <code>STATIC_ROOT</code> from your Django settings. In this example the <code>MEDIA_ROOT</code> is inside the <code>PROJECT_ROOT</code> and <code>STATIC_ROOT</code> is inside <code>SITE_ROOT</code>:</p>

<p><code>``
/home/web/sites/django.example.com
|-- demo_project
|   |-- __init__.py
|   |-- manage.py
|   |-- media
|   |-- settings.py
|  </code>-- urls.py
|-- static
`-- uwsgi</p>

<pre><code>|-- django_wsgi.py
|-- restart.txt
`-- uwsgi.conf
</code></pre>

<p>```</p>

<p>So let's add a <em>static handler</em> for <code>MEDIA_ROOT</code>:</p>

<ol>
<li>Choose "vServers" from the top menu</li>
<li>Select the vServer for which you want to add a static handler</li>
<li>Switch to the "Behavior" tab</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/rules/cherokee_admin_vserver_behavior.png" title="'Cherokee Admin'" ></p>

<p>Click the button called "Rule Management" and you will see all the rules for the vServer.</p>

<p><img src="/images/cherokee/v1_0_8/admin/vservers/rules/cherokee_admin_vserver_behavior_rules.png" title="'Cherokee Admin'" ></p>

<ol>
<li>Click the "New" button in the upper left corner</li>
<li>Choose "Manual" and the "Directory" rule type from the popup</li>
<li>Enter the directory name containing the static files (this is relative to the document root of the vServer)</li>
<li>Click "Add"</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/rules/static_handler/cherokee_admin_vserver_behavior_rule_new.png" title="'Cherokee Admin'" ></p>

<ol>
<li>Switch to the "Handler" tab</li>
<li>Set the handler to "Static Content"</li>
</ol>


<p><img src="/images/cherokee/v1_0_8/admin/vservers/rules/static_handler/cherokee_admin_vserver_behavior_handler_static.png" title="'Cherokee Admin'" ></p>

<p>Repeat these steps to add a handler for <code>STATIC_ROOT</code>. You may enter an absolute "Document Root" i.e. <code>/home/web/sites/django.example.com/static</code> since the static folder is one level above the vServer's document root.</p>

<h4>Restart</h4>

<p>Hit the "Save" button in the upper right corner and perform a "graceful restart". Your website should now be up and running.</p>

<p>Feel free to poke around the admin interface — there's a lot of stuff you can do in there.
Don't forget to stop the admin interface and close the tunnel once you're done.</p>
]]></content>
  </entry>
  
</feed>
